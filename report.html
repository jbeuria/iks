<html>
    <head>
        <script src="https://unpkg.com/pdf-lib@1.17.1"></script>
        <script src="https://unpkg.com/downloadjs@1.4.7"></script>
        <script type="text/javascript" src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
        <script>
            const { PDFDocument, StandardFonts, rgb }  = PDFLib;
            //import { PDFDocument, StandardFonts, rgb } from 'pdf-lib'
            async function embedPdfPages(rollno)
            {
                // Create a new PDFDocument
                const pdfDoc = await PDFDocument.create()

                // Embed the Times Roman font
                const timesRomanFont = await pdfDoc.embedFont(StandardFonts.TimesRoman)

                // Add a blank page to the document
                const page = pdfDoc.addPage()

                // Get the width and height of the page
                const { width, height } = page.getSize()
                
                //console.log(width,height);
                // Draw a string of text toward the top of the page
                const fontSize = 30

                function drawtext(x,y,text,font=timesRomanFont, size=12, color=rgb(0, 0,0))
                {
                    page.drawText(text, {
                    x: x,
                    y: height-y,
                    size: size,
                    font: font,
                    color: color,
                    })
                }
                var info_str= localStorage.getItem(rollno);
                var info=JSON.parse(info_str)
                //console.log(info);
                
                //info={name:'Vinay Kumar', rollno:"B123444", group:'Anxiety/Sleep'}
                var datestr=new Date().toLocaleDateString()
                drawtext( 500, 20,datestr, timesRomanFont, 12, rgb(0, 0.53, 0.71))
                drawtext( 45, 50,info.name, timesRomanFont, fontSize, rgb(0, 0.53, 0.71))
                drawtext( width-100, 50,info.rollno, timesRomanFont, 20)
                drawtext( 50, 70,'Group: '+info.group, timesRomanFont, 12)

                drawtext( 50, 140,'HRV (Baseline): '+info.hrv_baseline, timesRomanFont, 12)
                drawtext( 50, 170,'Stress: '+info.stress, timesRomanFont, 12)
                drawtext( 50, 200,'Anxiety: '+info.anxiety, timesRomanFont, 12)
                drawtext( 50, 230,'Depression: '+info.depression, timesRomanFont, 12)
                drawtext( 50, 260,'Happiness Index: '+info.happiness, timesRomanFont, 12)
                drawtext( 50, 290,'BMI: '+info.bmi, timesRomanFont, 12)

                
                drawtext(300, 140,'Class Attendance: '+info.class_attendance, timesRomanFont, 12)
                drawtext( 300, 170,'Lab Attendance: '+info.lab_attendance, timesRomanFont, 12)
                drawtext( 300, 200,'Quiz Marks: '+info.quiz, timesRomanFont, 12)
                drawtext( 300, 230,'Sattav Guna: '+info.sattva, timesRomanFont, 12)
                drawtext( 300, 260,'PANAS: '+info.panas, timesRomanFont, 12)
                
                //if(info.hrv_post)
                drawtext( 50, 320,'HRV (Post): '+info.hrv_post??"", timesRomanFont, 12)

                if(info.deep_sleep || info.total_sleep || info.sleep_onset)
                {

                    drawtext(50, 350,'Sleep Data: ', timesRomanFont, 18,rgb(1, 0, 0))

                    drawtext(50, 370,'Date ', timesRomanFont, 15,rgb(0, 0, 1))
                    drawtext(150, 370,'Deep Sleep', timesRomanFont, 15,rgb(0, 0, 1))
                    drawtext(250, 370,'Total Sleep', timesRomanFont, 15,rgb(0, 0, 1))
                    drawtext(350, 370,'Sleep Onset', timesRomanFont, 15,rgb(0, 0, 1))

                    
                    console.log(info.sleep_onset);
                    for(var i = 0; i < info.sleep_date.length; i++)
                    drawtext( 50, 390+i*20,info.sleep_date[i].toString(), timesRomanFont, 12)

                    for(var i = 0; i < info.deep_sleep.length; i++)
                    drawtext( 150, 390+i*20,info.deep_sleep[i].toString(), timesRomanFont, 12)

                    for(var i = 0; i < info.total_sleep.length; i++)
                    drawtext(250, 390+i*20,info.total_sleep[i].toString(), timesRomanFont, 12)

                    for(var i = 0; i < info.sleep_onset.length; i++)
                    drawtext( 350, 390+i*20,info.sleep_onset[i].toString(), timesRomanFont, 12)
                }

                drawtext( 50, 500,'Recommendations: ', timesRomanFont, 30)
                
                // Serialize the PDFDocument to bytes (a Uint8Array)
                const pdfBytes = await pdfDoc.save()
                // Trigger the browser to download the PDF document
                var filename=!!info.rollno??"report";

                download(pdfBytes, filename+".pdf", "application/pdf");
                
            }


        </script>

    </head>
    <body>
        <div class="container my-1 py-1">
            <h2 class="text-center mt-2 mb-2">Details of Participants</h2>
            <div class="card">
                <div class="card-header"><b>Select Excel File</b></div>
                <div class="card-body">
                    
                    <input type="file" id="excel_file" />
    
                </div>
            </div>
            <div id="excel_data" class="mt-5"></div>
        </div>

    </body>
</html>


<script>

    const excel_file = document.getElementById('excel_file');
    
    excel_file.addEventListener('change', (event) => {
    
        if(!['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'].includes(event.target.files[0].type))
        {
            document.getElementById('excel_data').innerHTML = '<div class="alert alert-danger">Only .xlsx or .xls file format are allowed</div>';
    
            excel_file.value = '';
    
            return false;
        }
    
        var reader = new FileReader();
    
        reader.readAsArrayBuffer(event.target.files[0]);
    
        reader.onload = function(event){
    
            var data = new Uint8Array(reader.result);
    
            var work_book = XLSX.read(data, {type:'array'});
    
            var sheet_name = work_book.SheetNames;
    
            var sheet_data = XLSX.utils.sheet_to_json(work_book.Sheets[sheet_name[0]], {header:1});
    
            localStorage.clear();
            if(sheet_data.length > 0)
            {
                var table_output = '<table class="table table-striped table-bordered">';
              
                var info_headers=sheet_data[0];
                
                for(var row = 0; row < sheet_data.length; row++)
                {
                    table_output += '<tr>';
                    
                    if(row>0)
                    {
                        var student_info=getStudentInfo(sheet_data[row],info_headers)
                        localStorage.setItem(student_info.roll.toString().toLowerCase(), student_info);
                    }

                    for(var cell = 0; cell < sheet_data[row].length; cell++)
                    {
                        if(row == 0)
                        {
    
                            table_output += '<th>'+sheet_data[row][cell]+'</th>';
                            localStorage.clear();
    
                        }
                        else
                        {
                            var btn_string= `${sheet_data[row][cell]}`
                            if(cell==0)
                            {
                                //console.log(json_str)
                                btn_string=  `<a href='#' onclick="embedPdfPages(${student_info.rollno})" role='button' class="form-control btn btn-sm btn-primary">${sheet_data[row][cell]}</a>`
                            }
                            //console.log(btn_string);
                            table_output += '<td>'+btn_string+'</td>';
    
                        }
    
                    }
                        
                    table_output += '</tr>';
    
                }
    
                table_output += '</table>';
    
                document.getElementById('excel_data').innerHTML = table_output;
            }
    
            excel_file.value = '';
    
        }
    
    });
    
    function getStudentInfo(sheet_row,headers)
    {

        let info={};

        for(var cell = 0; cell < sheet_row.length; cell++)
        {   
            if(headers[cell].toLowerCase().includes('name')) info.name=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('roll')) info.rollno=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('group')) info.group=sheet_row[cell];

            if(headers[cell].toLowerCase().includes('hrv') && headers[cell].toLowerCase().includes('baseline')) info.hrv_baseline=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('stress')) info.stress=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('anxiety')) info.anxiety=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('depression')) info.depression=sheet_row[cell];


            if(headers[cell].toLowerCase().includes('happiness')) info.happiness=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('bmi')) info.bmi=sheet_row[cell];

            if(headers[cell].toLowerCase().includes('panas')) info.panas=sheet_row[cell];

            if(headers[cell].toLowerCase().includes('class') && headers[cell].toLowerCase().includes('attendance')) info.class_attendance=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('lab') && headers[cell].toLowerCase().includes('attendance')) info.lab_attendance=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('quiz')) info.quiz=sheet_row[cell];
            if(headers[cell].toLowerCase().includes('sattva')) info.sattva=sheet_row[cell];


            if(headers[cell].toLowerCase().includes('hrv') && headers[cell].toLowerCase().includes('post')) info.hrv_post=sheet_row[cell];

            if(headers[cell].toLowerCase().includes('sleep'))
            {
                if(!info.sleep_date) info.sleep_date=[];
                if(!info.deep_sleep) info.deep_sleep=[];
                if(!info.total_sleep) info.total_sleep=[];
                if(!info.sleep_onset) info.sleep_onset=[];

                if(headers[cell].toLowerCase().includes('date')) info.sleep_date.push(sheet_row[cell]??"NA");
                if(headers[cell].toLowerCase().includes('deep')) info.deep_sleep.push(sheet_row[cell]??"NA");
                if(headers[cell].toLowerCase().includes('total')) info.total_sleep.push(sheet_row[cell]??"NA");
                if( headers[cell].toLowerCase().includes('onset')) info.sleep_onset.push(sheet_row[cell]??"NA");
            }


        }
        //console.log(info)
        return info;

    }

    document.addEventListener("DOMContentLoaded", function(event) {
     localStorage.clear()
    });
    </script>


